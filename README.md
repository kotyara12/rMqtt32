# MQTT client for ESP32 / ESP-IDF

MQTT клиент ESP32 и ESP-IDF (_не будет работать в Arduino_) с возможностью настройки до двух MQTT брокеров с автоматическими переключением между ними. Брокер может быть "_локальным_" (то есть доступным только в пределах локальной сети, к которой подключено ESP), либо "_публичным_" (то есть доступным из сети интернет). Это позволяет реализовать схему работы, когда в качестве основого MQTT брокера используется [локальный сервер на роутере с мостом на внешний](https://kotyara12.ru/pubs/iot/keenetic-mqtt/) (либo брокер Home Assistant, например), а в качестве резервного - любой публичный. В этом случае, при потере доступа из локальной сети к интернет устройство продолжает успешно функционировать на локальном брокере, но мы теряем возможность внешнего управления извне. И наоборот, если по какой-либо причине происходит потеря доступа к основному брокеру, то устройство автоматически переключится на резервный сервер. Можно также указать в качестве основного и резервного брокра публичные сервера, просто повысив надежность системы. Либо использовать только один сервер, как обычно.

Библиотека основана на ESP-IDF библиотеке "mqtt_client.h", поэтому вряд ли будет работать на Arduino фреймворке. По сути, это просто "обертка" вокруг "mqtt_client.h" для более удобного использования и автоматического выбора сервера. Вам следует учесть, что данная библиотека интегрирована в удобную событийную систему, релизованную с помощью других библиотек [reEvents](https://github.com/kotyara12/reEvents) и [reStates](https://github.com/kotyara12/reStates). _Полный список зависимостей от других библиотек смотрите ниже в разделе "Зависимости"_. Если вы не планируете использовать весь набор библиотек, представленных в моем профиле, вам стоит создать форк и изменить код по своему желанию.

## Использование:

#### Создание и запуск задачи MQTT клиента
Функция ```mqttTaskStart``` создает и, возможно, запускает задачу MQTT-клиента. Параметр ```createSuspended``` позволяет _создать задачу в приостановленном виде_, чтобы _запустить её позже по событию подключению у WiFi сети_ и (или) получению доступа в интернет.
```
bool mqttTaskStart(bool createSuspended);
```
#### Остановка и удаление задачи MQTT клиента
Данная функция может быть вызвана перед перезагрузкой устройства.
```
bool mqttTaskStop();
```

#### Приостановка и восстановление задачи MQTT клиента
```
bool mqttTaskSuspend();
bool mqttTaskResume();
```
Данные функции могут быть использованы для приостановки задачи на время, когда устройство отключилось от WiFi сети или потерян доступ к серверу.

## Зависмости:
  - esp_event_base.h (ESP-IDF)
  - mqtt_client.h (ESP-IDF)
  - project_config.h (настройки проекта)
  - https://github.com/kotyara12/rLog
  - https://github.com/kotyara12/rStrings
  - https://github.com/kotyara12/reEsp32
  - https://github.com/kotyara12/reEvents
  - https://github.com/kotyara12/reStates
  - https://github.com/kotyara12/reWifi
  - https://github.com/kotyara12/reNvs

## Примечания:
Данные замечания относятся к моим библиотекам, размещенным на ресурсе https://github.com/kotyara12?tab=repositories.

- библиотеки, название которых начинается с префикса **re**, предназначены только для ESP32 и ESP-IDF (FreeRTOS)
- библиотеки, название которых начинается с префикса **ra**, предназначены только для ARDUINO
- библиотеки, название которых начинается с префикса **r**, могут быть использованы и для ARDUINO, и для ESP-IDF

Так как я в настроящее время разрабатываю программы в основном для ESP-IDF, основная часть моих библиотек предназначена только для этого фреймворка. Но Вы можете портировать их для другой системы, взяв за основу.
